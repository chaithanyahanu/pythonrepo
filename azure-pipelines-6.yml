trigger:
- main

variables:
- group: pythongroup        # ACR_LOGIN_SERVER, IMAGE_NAME, STORAGE_ACCOUNT, STORAGE_CONTAINER, STORAGE_KEY, TEAMS_WEBHOOK_URL, AZURE_SERVICE_CONNECTION
- name: imageTag
  value: $(Build.BuildId)

pool:
  vmImage: ubuntu-latest   # MICROSOFT HOSTED AGENT

# ===============================
# STAGE 0 - Notify Start
# ===============================
stages:
- stage: NotifyStart
  displayName: Notify Microsoft Teams (Start)
  jobs:
  - job: TeamsStartNotify
    displayName: Send Teams Notification (Start)
    steps:
    - checkout: none

    - bash: |
        STATUS="üöÄ Pipeline Started"

        PIPELINE_URL="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=results"

        payload="{
          \"@type\": \"MessageCard\",
          \"@context\": \"http://schema.org/extensions\",
          \"summary\": \"Pipeline Started\",
          \"themeColor\": \"0076D7\",
          \"sections\": [{
            \"activityTitle\": \"Azure DevOps Pipeline Started\",
            \"facts\": [
              {\"name\": \"Pipeline\", \"value\": \"$(Build.DefinitionName)\"},
              {\"name\": \"Branch\", \"value\": \"$(Build.SourceBranchName)\"},
              {\"name\": \"Run ID\", \"value\": \"$(Build.BuildId)\"}
            ]
          }]
        }"

        curl -H "Content-Type: application/json" \
             -d "$payload" \
             $(TEAMS_WEBHOOK_URL)
      displayName: Send Teams Start Notification


# ===============================
# STAGE 1 - ZIP Backup + Build & Push ACR
# ===============================
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: DockerBuildPush
    displayName: Build & Push Image
    steps:
    - checkout: self

    # -----------------------------------------
    # Step 1: Create ZIP Backup with Date-Time
    # -----------------------------------------
    - bash: |
        echo "Creating ZIP backup..."

        export ZIP_NAME="backup_$(date +'%Y%m%d_%H%M%S').zip"
        echo "Zip Name: $ZIP_NAME"

        zip -r "$ZIP_NAME" . -x "*.git*"

        echo "##vso[task.setvariable variable=ZIP_NAME]$ZIP_NAME"
      displayName: Create ZIP Backup Before Build

    # -----------------------------------------
    # Step 2: Upload ZIP under folder: <appName>/backup.zip
    # -----------------------------------------
    - task: AzureCLI@2
      displayName: Upload ZIP to Blob Storage
      inputs:
        azureSubscription: $(AZURE_SERVICE_CONNECTION)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          APP_FOLDER="$(IMAGE_NAME)"   # folder = application name

          echo "Uploading $ZIP_NAME to folder: $APP_FOLDER"

          az storage blob upload \
            --account-name $(STORAGE_ACCOUNT) \
            --container-name $(STORAGE_CONTAINER) \
            --name "${APP_FOLDER}/${ZIP_NAME}" \
            --file "$ZIP_NAME" \
            --auth-mode key \
            --account-key "$(STORAGE_KEY)"

    # -----------------------------------------
    # Step 3: Docker Login to ACR
    # -----------------------------------------
    - task: Docker@2
      displayName: Login to ACR
      inputs:
        command: login
        containerRegistry: pythoncodereg

    # -----------------------------------------
    # Step 4: Build & Push Docker Image
    # -----------------------------------------
    - bash: |
        docker build -t $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag) .
        docker push $(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag)
      displayName: Build & Push Docker Image


# ===============================
# STAGE 2 - Notify End
# ===============================
- stage: Notify
  displayName: Notify Microsoft Teams (End)
  dependsOn: BuildAndPush
  condition: always()
  jobs:
  - job: TeamsNotify
    displayName: Send Teams Notification
    variables:
      BUILD_STAGE_RESULT: $[ stageDependencies.BuildAndPush.DockerBuildPush.result ]

    steps:
    - checkout: none

    - bash: |
        echo "Build stage result: $(BUILD_STAGE_RESULT)"

        if [ "$(BUILD_STAGE_RESULT)" == "Succeeded" ]; then
          STATUS="‚úÖ Success"
          COLOR="00C853"
        elif [ "$(BUILD_STAGE_RESULT)" == "Skipped" ]; then
          STATUS="‚ö†Ô∏è Skipped"
          COLOR="FFD600"
        else
          STATUS="‚ùå Failed"
          COLOR="D32F2F"
        fi

        PIPELINE_URL="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"

        payload="{
          \"@type\": \"MessageCard\",
          \"@context\": \"http://schema.org/extensions\",
          \"summary\": \"Pipeline Result\",
          \"themeColor\": \"${COLOR}\",
          \"sections\": [{
            \"activityTitle\": \"Azure DevOps Pipeline Result\",
            \"facts\": [
              {\"name\": \"Pipeline\", \"value\": \"$(Build.DefinitionName)\"},
              {\"name\": \"Branch\", \"value\": \"$(Build.SourceBranchName)\"},
              {\"name\": \"Run ID\", \"value\": \"$(Build.BuildId)\"},
              {\"name\": \"Docker Image\", \"value\": \"$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag)\"},
              {\"name\": \"Status\", \"value\": \"${STATUS}\"}
            ]
          }]
        }"

        curl -H "Content-Type: application/json" \
             -d "$payload" \
             $(TEAMS_WEBHOOK_URL)
      displayName: Send Teams Notification
