trigger:
- main

variables:
- group: pythongroup        # contains: ACR_LOGIN_SERVER, IMAGE_NAME, TEAMS_WEBHOOK_URL
- name: imageTag
  value: $(Build.BuildId)

pool:
  vmImage: ubuntu-latest

stages:
# -------------------------------
# Stage 1: Build Docker Image
# -------------------------------
- stage: Build
  displayName: Build Docker Image
  jobs:
  - job: BuildImage
    steps:
    - checkout: self
    - script: |
        IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag)"
        echo "üì¶ Building Docker image: $IMAGE"
        docker build -t $IMAGE .
      displayName: Build Docker Image

# -------------------------------
# Stage 2: Push Docker Image
# -------------------------------
- stage: Push
  displayName: Push Docker Image to ACR
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: PushImage
    environment: acr-approval     # manual approval environment
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: acr-pythoncode   # existing ACR service connection
          - script: |
              IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag)"
              echo "üì§ Pushing Docker image: $IMAGE"
              docker push $IMAGE
            displayName: Push Docker Image

# -------------------------------
# Stage 3: Notify Microsoft Teams
# -------------------------------
- stage: Notify
  displayName: Notify Microsoft Teams
  dependsOn:
    - Build
    - Push
  condition: always()
  variables:
    buildResult: $[ dependencies.Build.result ]
    pushResult:  $[ dependencies.Push.result ]
  jobs:
  - job: TeamsNotify
    steps:
    - checkout: none
    - bash: |
        # Determine overall pipeline status
        if [ "$(buildResult)" != "Succeeded" ] || [ "$(pushResult)" != "Succeeded" ]; then
          STATUS="‚ùå Failed"
        else
          STATUS="‚úÖ Success"
        fi

        IMAGE="$(ACR_LOGIN_SERVER)/$(IMAGE_NAME):$(imageTag)"

        # Direct Azure DevOps pipeline run URL
        PIPELINE_URL="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=results"

        # Message card for Teams
        payload="{
          \"@type\": \"MessageCard\",
          \"@context\": \"http://schema.org/extensions\",
          \"summary\": \"Azure DevOps Pipeline Result\",
          \"themeColor\": \"0076D7\",
          \"sections\": [{
            \"activityTitle\": \"Azure DevOps Pipeline Notification\",
            \"facts\": [
              {\"name\": \"Pipeline\", \"value\": \"$(Build.DefinitionName)\"},
              {\"name\": \"Branch\", \"value\": \"$(Build.SourceBranchName)\"},
              {\"name\": \"Run ID\", \"value\": \"$(Build.BuildId)\"},
              {\"name\": \"Docker Image\", \"value\": \"${IMAGE}\"},
              {\"name\": \"Status\", \"value\": \"${STATUS}\"}
            ]
          }],
          \"potentialAction\": [{
            \"@type\": \"OpenUri\",
            \"name\": \"üîó View Pipeline\",
            \"targets\": [
              {\"os\": \"default\", \"uri\": \"${PIPELINE_URL}\"}
            ]
          }]
        }"

        echo "Sending Teams notification with status: $STATUS"
        curl -H "Content-Type: application/json" \
             -d "$payload" \
             $(TEAMS_WEBHOOK_URL)
      displayName: Send Teams Notification
