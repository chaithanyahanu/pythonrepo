trigger:
- main

variables:
- group: pythongroup       # Secrets group (contains TEAMS_WEBHOOK_URL)
- name: imageTag
  value: $(Build.BuildId)
- name: IMAGE_NAME
  value: sample-fastapi-api       # ðŸ‘ˆ Set your image name
- name: ACR_LOGIN_SERVER
  value: pythoncodereg.azurecr.io # ðŸ‘ˆ Set your ACR login server

pool:
  vmImage: ubuntu-latest

stages:
# -------------------------------
# Stage 1: Build Docker Image
# -------------------------------
- stage: Build
  displayName: Build Docker Image
  jobs:
  - job: BuildImage
    steps:
    - checkout: self
    - script: |
        IMAGE=${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${imageTag}
        echo "ðŸ“¦ Building Docker image: $IMAGE"
        docker build -t $IMAGE .
      displayName: Build Docker Image

# -------------------------------
# Stage 2: Push Docker Image
# -------------------------------
- stage: Push
  displayName: Push Docker Image to ACR
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: PushImage
    environment: acr-approval   # Manual approval environment
    strategy:
      runOnce:
        deploy:
          steps:
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: acr-pythoncode
          - script: |
              IMAGE=${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${imageTag}
              echo "ðŸ“¤ Pushing Docker image: $IMAGE"
              docker push $IMAGE
            displayName: Push Docker Image

# -------------------------------
# Stage 3: Notify Microsoft Teams
# ------------------------------
- stage: Notify
  displayName: "Send Teams Notification"
  jobs:
  - job: TeamsNotify
    displayName: "Post notification to Teams"
    steps:
    - bash: |
        PIPELINE_URL="https://dev.azure.com/$(System.CollectionName)/$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
        echo "Sending Teams notification..."
        payload=$(cat <<'EOF'
        {
          "@type": "MessageCard",
          "@context": "https://schema.org/extensions",
          "summary": "Azure DevOps Pipeline Notification",
          "themeColor": "0076D7",
          "title": "Azure DevOps Pipeline Notification",
          "sections": [
            {
              "facts": [
                {"name": "Pipeline", "value": "$(Build.DefinitionName)"},
                {"name": "Branch", "value": "$(Build.SourceBranchName)"},
                {"name": "Run ID", "value": "$(Build.BuildId)"},
                {"name": "Docker Image", "value": "pythoncodereg.azurecr.io/sample-fastapi-api:$(Build.BuildId)"},
                {"name": "Status", "value": "$(Build.Status)"}
              ],
              "markdown": true
            }
          ],
          "potentialAction": [
            {
              "@type": "OpenUri",
              "name": "ðŸ”— View Pipeline",
              "targets": [
                {"os": "default", "uri": "PIPELINE_URL_PLACEHOLDER"}
              ]
            }
          ]
        }
        EOF
        )
        # Replace placeholder with actual URL
        payload=${payload//PIPELINE_URL_PLACEHOLDER/$PIPELINE_URL}

        # Send to Teams
        curl -H "Content-Type: application/json" -d "$payload" "$(teamsWebhook)"
      displayName: "Send Teams Card"

